trigger:
  branches:
    include:
      - main

variables:
  azureServiceConnection: 'AzureConn'    
  subscriptionId: '2edf1b4c-7dc2-4bae-883b-d07e9e31d584'
  resourceGroup: 'rg-storage-demo'             

stages:
  - stage: Validate
    displayName: 'Validate ARM Template'
    jobs:
      - job: validate
        pool:
          name: 'Default'   # <-- Replace with your self-hosted pool name
        steps:
          - checkout: self

          # Debug step to confirm files exist
          - script: |
              echo "Working directory: $(Build.SourcesDirectory)"
              dir $(Build.SourcesDirectory)\infra
            displayName: 'List infra folder contents'

          - task: AzureCLI@2
            displayName: 'What-If Deployment'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: ps
              scriptLocation: inlineScript
              inlineScript: |
                az deployment group what-if `
                  --subscription $(subscriptionId) `
                  --resource-group $(resourceGroup) `
                  --template-file $(Build.SourcesDirectory)\infra\storage.json `
                  --parameters @$(Build.SourcesDirectory)\infra\storage.parameters.dev.json

  - stage: Deploy
    displayName: 'Deploy Storage Account'
    dependsOn: Validate
    jobs:
      - job: deploy
        pool:
          name: 'Default'   # <-- Same pool for consistency
        steps:
          - checkout: self

          # Debug step again before deployment
          - script: |
              echo "Working directory: $(Build.SourcesDirectory)"
              dir $(Build.SourcesDirectory)\infra
            displayName: 'List infra folder contents'

          - task: AzureCLI@2
            displayName: 'Deploy ARM Template'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: ps
              scriptLocation: inlineScript
              inlineScript: |
                az deployment group create `
                  --subscription $(subscriptionId) `
                  --resource-group $(resourceGroup) `
                  --name "storage-deploy-$(Build.BuildId)" `
                  --template-file $(Build.SourcesDirectory)\infra\storage.json `
                  --parameters @$(Build.SourcesDirectory)\infra\storage.parameters.dev.json `
                  --verbose
